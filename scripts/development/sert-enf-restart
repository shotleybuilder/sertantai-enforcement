#!/bin/bash
# sertantai-enforcement Development Server Restarter
# Forcefully stops and restarts backend (Phoenix) and frontend (SvelteKit) servers
#
# Usage:
#   sert-enf-restart          # Restart servers only (leave Docker running)
#   sert-enf-restart --docker # Restart servers + Docker containers
#   sert-enf-restart --force  # Force kill immediately (skip graceful shutdown)

set -e

# Parse arguments
MANAGE_DOCKER=false
FORCE_KILL=false
for arg in "$@"; do
    case $arg in
        --docker)
            MANAGE_DOCKER=true
            ;;
        --force)
            FORCE_KILL=true
            ;;
    esac
done

# Resolve symlink to get the actual script path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

echo "ğŸ”„ Restarting sertantai-enforcement development servers..."
echo ""

# Function to kill processes with timeout and retry
kill_process_safely() {
    local process_pattern="$1"
    local process_name="$2"
    local max_wait=5

    if pgrep -f "$process_pattern" > /dev/null; then
        echo "ğŸ”¥ Stopping $process_name..."

        if [ "$FORCE_KILL" = true ]; then
            # Force kill immediately
            pkill -9 -f "$process_pattern" || true
            echo "   âœ… $process_name force-killed"
        else
            # Try graceful shutdown first (SIGTERM)
            pkill -f "$process_pattern" || true

            # Wait up to max_wait seconds for graceful shutdown
            local waited=0
            while pgrep -f "$process_pattern" > /dev/null && [ $waited -lt $max_wait ]; do
                sleep 1
                waited=$((waited + 1))
                echo -n "."
            done
            echo ""

            # If still running, force kill (SIGKILL)
            if pgrep -f "$process_pattern" > /dev/null; then
                echo "   âš ï¸  Graceful shutdown timed out, force killing..."
                pkill -9 -f "$process_pattern" || true
                sleep 1
            fi

            echo "   âœ… $process_name stopped"
        fi
    else
        echo "â„¹ï¸  $process_name not running"
    fi
}

# Function to check if port is free
wait_for_port_free() {
    local port="$1"
    local max_wait=10
    local waited=0

    while lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1 && [ $waited -lt $max_wait ]; do
        if [ $waited -eq 0 ]; then
            echo "â³ Waiting for port $port to be freed..."
        fi
        sleep 1
        waited=$((waited + 1))
        echo -n "."
    done

    if [ $waited -gt 0 ]; then
        echo ""
    fi

    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo "   âš ï¸  Port $port still in use after ${max_wait}s"
        echo "   Process using port:"
        lsof -Pi :$port -sTCP:LISTEN || true
        echo "   Killing process on port $port..."
        lsof -ti:$port | xargs kill -9 2>/dev/null || true
        sleep 1
    fi
}

# Stop existing processes
echo "ğŸ“‹ Step 1/3: Stopping existing processes"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Kill Phoenix backend
kill_process_safely "mix phx.server" "Phoenix backend"

# Kill Elixir BEAM processes (in case mix process doesn't catch them all)
if pgrep -f "beam.smp.*sertantai" > /dev/null; then
    echo "ğŸ”¥ Stopping BEAM VM processes..."
    pkill -9 -f "beam.smp.*sertantai" || true
    echo "   âœ… BEAM processes stopped"
fi

# Kill SvelteKit frontend
kill_process_safely "vite dev.*5173" "SvelteKit frontend"

# Kill any node processes on port 5173
if lsof -ti:5173 >/dev/null 2>&1; then
    echo "ğŸ”¥ Killing remaining processes on port 5173..."
    lsof -ti:5173 | xargs kill -9 2>/dev/null || true
fi

echo ""

# Wait for ports to be freed
echo "ğŸ“‹ Step 2/3: Ensuring ports are available"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
wait_for_port_free 4002  # Phoenix backend
wait_for_port_free 5173  # SvelteKit frontend

echo "   âœ… Ports 4002 and 5173 are free"
echo ""

# Handle Docker if requested
if [ "$MANAGE_DOCKER" = true ]; then
    echo "ğŸ³ Managing Docker containers..."
    cd "$PROJECT_ROOT"

    # Stop existing containers
    docker compose -f docker-compose.dev.yml down

    # Start fresh containers
    echo "   Starting Docker services (postgres, electric, redis)..."
    docker compose -f docker-compose.dev.yml up -d postgres electric redis

    echo "   Waiting for services to be healthy..."
    sleep 5

    # Verify Docker services are up
    if docker ps | grep -q "ehs_dev_postgres"; then
        echo "   âœ… Docker services running"
    else
        echo "   âš ï¸  Warning: Docker services may not be fully ready"
    fi
    echo ""
fi

# Start servers
echo "ğŸ“‹ Step 3/3: Starting development servers"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Verify PROJECT_ROOT and mix.exs exist
if [ ! -d "$PROJECT_ROOT" ] || [ ! -f "$PROJECT_ROOT/mix.exs" ]; then
    echo "âŒ Error: Project root or mix.exs not found"
    exit 1
fi

# Check Docker if not managing it
if [ "$MANAGE_DOCKER" = false ]; then
    if ! docker ps | grep -q "ehs_dev_postgres"; then
        echo "âš ï¸  Docker containers not detected"
        echo "   Tip: Use 'sert-enf-restart --docker' to restart with Docker"
        echo ""
    fi
fi

echo "ğŸ“¦ Opening terminal windows..."

# Open Phoenix Backend terminal
gnome-terminal --title="sertantai-enforcement-backend" -- bash -c "cd \"$PROJECT_ROOT\" && echo 'ğŸ”¥ Starting Phoenix backend on port 4002...' && echo \"ğŸ“ Working directory: \$(pwd)\" && echo '' && mix phx.server" &

# Wait a moment for first terminal to open
sleep 0.5

# Open SvelteKit Frontend terminal
gnome-terminal --title="sertantai-enforcement-frontend" -- bash -c "cd \"$PROJECT_ROOT/frontend\" && echo 'âš¡ Starting SvelteKit frontend on port 5173...' && echo \"ğŸ“ Working directory: \$(pwd)\" && echo '' && npm run dev" &

# Wait a moment
sleep 0.5

# Open Console terminal
gnome-terminal --title="sertantai-enforcement-console" -- bash -c "cd \"$PROJECT_ROOT\" && echo 'ğŸ’» sertantai-enforcement Development Console' && echo \"ğŸ“ Working directory: \$(pwd)\" && echo '' && echo 'ğŸ“Š Available endpoints:' && echo '   Backend:  http://localhost:4002' && echo '   Frontend: http://localhost:5173' && echo '   Electric: http://localhost:3001' && echo '' && echo 'ğŸ® Quick commands:' && echo '   Stop servers:     sert-enf-stop' && echo '   Restart:          sert-enf-restart' && echo '   Force restart:    sert-enf-restart --force' && echo '   Docker logs:      docker compose -f docker-compose.dev.yml logs -f' && echo '   Phoenix console:  iex -S mix phx.server' && echo '' && read -p 'Press Enter to close...'" &

echo ""
echo "âœ… Development servers restarted successfully!"
echo ""
echo "ğŸ“Š URLs:"
echo "   Backend:  http://localhost:4002"
echo "   Frontend: http://localhost:5173"
echo "   Electric: http://localhost:3001"
echo ""
echo "ğŸ’¡ Tips:"
echo "   Stop servers:     sert-enf-stop"
echo "   Restart again:    sert-enf-restart"
echo "   Force restart:    sert-enf-restart --force"
if [ "$MANAGE_DOCKER" = true ]; then
    echo "   (Docker was restarted)"
else
    echo "   (Docker was not restarted - use --docker flag to restart Docker)"
fi
echo ""
